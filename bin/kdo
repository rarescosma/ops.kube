#!/bin/bash

set -o nounset
set -o pipefail

SCRIPTPATH=$( cd -P "$( dirname $(readlink -f "${BASH_SOURCE[0]}") )" && pwd )
ADDONS_ROOT="${SCRIPTPATH}/../addons"
APPS_ROOT="${SCRIPTPATH}/../apps"
DOCKER_REGISTRY="localhost:5000"
source $SCRIPTPATH/../share/do -lib

up() {
  cluster::up
  resolvconf::up
}

down() {
  resolvconf::down
  cluster::down
}

resolvconf::up() {
  cat << __EOF__ | sudo tee /etc/resolv.conf
search svc.kubernetes.local
nameserver 10.32.0.10
nameserver 10.0.40.129
__EOF__
}

resolvconf::down() {
  sudo resolvconf -u
}

addon::dns() {
  deploy::recreate_addon dns/kubedns-deployment.yaml
  deploy::recreate_addon dns/kubedns-service.yaml
}

addon::dashboard() {
  deploy::recreate_addon dashboard/dashboard-controller.yaml
  deploy::recreate_addon dashboard/dashboard-service.yaml
}

addons() {
  addon::dns
  addon::dashboard
}

app::guestbook() {
  deploy::recreate_app guestbook/all-in-one/guestbook-all-in-one.yaml
}

apps() {
  app::guestbook
}

upgrade::frontend() {
  local version=$1
  kubectl set image deployment/frontend \
    "php-redis=${DOCKER_REGISTRY}/guestbook/frontend:${version}"
}

upgrade::redis() {
  local version=$1
  kubectl set image deployment/redis-slave \
    "slave=${DOCKER_REGISTRY}/redis-slave:${version}"
}

upgrade::guestbook() {
  local version=$1
  upgrade::frontend $version
  upgrade::redis $version
}

# Verbatim
$@
