#!/usr/bin/env bash

set -o nounset
set -o pipefail

DOT=$( cd -P "$( dirname $(readlink -f "${BASH_SOURCE[0]}") )" && pwd )
ADDONS_ROOT="${DOT}/../addons"
APPS_ROOT="${DOT}/../apps"
source $DOT/../share/do -lib

add_worker() {
  local index=$1; shift
  orchestrate::worker $index
  utils::function_exists "host::post" && host::post
  network::cycle
}

deploy::replace_addon() {
  local addon="$1"
  kubectl replace -f "${ADDONS_ROOT}/${addon}"
}

deploy::apply_addon() {
  local addon="$1"
  kubectl apply -f "${ADDONS_ROOT}/${addon}"
}

deploy::recreate_addon() {
  local addon="$1"
  kubectl delete -f "${ADDONS_ROOT}/${addon}" 2>/dev/null
  kubectl create -f "${ADDONS_ROOT}/${addon}"
}

addon::registry() {
  deploy::apply_addon docker-registry/docker-registry-daemonset.yaml
}

addon::dns() {
  deploy::recreate_addon dns/kubedns-daemonset.yaml
  deploy::recreate_addon dns/kubedns-service.yaml
}

addon::dashboard() {
  deploy::recreate_addon dashboard/dashboard-controller.yaml
  deploy::recreate_addon dashboard/dashboard-service.yaml
}

# Verbatim
$@
