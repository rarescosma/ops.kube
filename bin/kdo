#!/bin/bash

set -o nounset
set -o pipefail

SCRIPTPATH=$( cd -P "$( dirname $(readlink -f "${BASH_SOURCE[0]}") )" && pwd )
ADDONS_ROOT="${SCRIPTPATH}/../addons"
APPS_ROOT="${SCRIPTPATH}/../apps"
DOCKER_REGISTRY="localhost:5000"
source $SCRIPTPATH/../share/do -lib

up() {
  prepare
  cluster::up
  fixx
  resolvconf::up
}

down() {
  resolvconf::down
  cluster::down
}

add_worker() {
  local index=$1; shift
  orchestrate::worker $index
  fixx
  post::route
}

resolvconf::up() {
  cat << __EOF__ | sudo tee /etc/resolv.conf
search svc.kubernetes.local
nameserver 10.32.0.10
nameserver 10.0.40.129
__EOF__
  sudo chattr +i /etc/resolv.conf
}

resolvconf::down() {
  sudo chattr -i /etc/resolv.conf
  sudo resolvconf -u
}

fixx() {
  sleep 1
  xmodmap ~/.Xmodmap
}

addon::dns() {
  deploy::recreate_addon dns/kubedns-deployment.yaml
  deploy::recreate_addon dns/kubedns-service.yaml
}

addon::dashboard() {
  deploy::recreate_addon dashboard/dashboard-controller.yaml
  deploy::recreate_addon dashboard/dashboard-service.yaml
}

addons() {
  addon::dns
  addon::dashboard
}

# Verbatim
$@
